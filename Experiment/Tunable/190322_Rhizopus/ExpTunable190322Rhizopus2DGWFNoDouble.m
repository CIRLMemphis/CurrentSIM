run("ExpTunable190322RhizopusSetup.m");
load(CIRLDataPath + "/TunableData/190322_Rhizopus/190322_Rhizopus.mat", 'g');

%% get the FT of g
[Y,X,Z,Nthe,Nphi] = size(g);
G = zeros(Y,X,Z,Nthe,Nphi);
for l = 1:Nthe
    for k = 1:Nphi
        G(:,:,:,l,k) = FT(g(:,:,:,l,k));
    end
end

%% Wiener parameter
wD = 0.05;

% lateral fractions
qn = [0, 1, -1]; % qn = (1:Nphi) - (Nphi+1)/2;

% decomposition matrix coefficients
cn = [1, 1/2, 1/2];

% input OTFs
Nphi   = length(phi);
Hn     = zeros(Y,X,Z,Nphi);
vn     = ones(1,1,Z,Nphi);
vn(1,1,:,2) = im(1,1,:,1,1,2);
vn(1,1,:,3) = im(1,1,:,1,1,2);
for k = 1:length(phi)
    Hn(:,:,:,k) = FT(h.*vn(1,1,:,k));
end

tempHn = zeros(Y, X, length(phi));
for k = 1:length(phi)
    tempHn(:,:,k) = sum(Hn(:,:,:,k),3);
end
Hn = tempHn;

zInd = 151;
reconOb = OTF2DGWFCore(...
                             reshape(G(:,:,zInd,:,:),[X,Y,1,Nphi]),  ...
                             Hn, ...
                             qn, ...
                             cn, ...
                             uc, ...
                             omegaXY, ...
                             phi, ...
                             offs, ...
                             theta, ...
                             wD, ...
                             dXY, dZ, ...
                             -1, 0, 0, [], 1, [], 0);
                         
%%
reconOb(reconOb < 0) = 0;
figure; imagesc(reconOb); axis square; colormap jet;

% reconOb = zeros(Y*2, X*2, Z);
% for zInd = 1:Z
%     zInd
%     reconOb(:,:,zInd) = OTF2DGWFCore(...
%                              squeeze(g(:,:,zInd,:,:)),  ...
%                              Hn, ...
%                              qn, ...
%                              cn, ...
%                              uc, ...
%                              omegaXY, ...
%                              phi, ...
%                              offs, ...
%                              theta, ...
%                              wD, ...
%                              dXY, dZ, ...
%                              -1, 0, 0, [], 1, [], 0);
% end
% 
% 
% save('ExpTunable190322Rhizopus2DGWFNoDouble');